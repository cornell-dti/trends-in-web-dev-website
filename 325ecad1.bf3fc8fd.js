/*! For license information please see 325ecad1.bf3fc8fd.js.LICENSE.txt */
(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{148:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return c})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return p})),n.d(t,"default",(function(){return b}));var o=n(1),a=n(9),s=(n(0),n(162)),r=n(167),i=n(166),c={id:"lecture3",title:"Lecture 3"},l={id:"lecture3",title:"Lecture 3",description:"[Lecture Slides](https://docs.google.com/presentation/d/1iimIRpAw1ud1yhCCx1cdwypZw2J8VVN8mTLWXOc8g-U/edit?usp=sharing)",source:"@site/docs/lecture3.md",permalink:"/docs/lecture3",sidebar:"docs",previous:{title:"Lecture 2",permalink:"/docs/lecture2"},next:{title:"Lecture 4",permalink:"/docs/lecture4"}},p=[{value:"Before the lecture",id:"before-the-lecture",children:[{value:"Install Postman",id:"install-postman",children:[]},{value:"Firebase Setup",id:"firebase-setup",children:[]},{value:"Check your setup",id:"check-your-setup",children:[]}]},{value:"Basic Database Manipulations",id:"basic-database-manipulations",children:[]},{value:"Sample code",id:"sample-code",children:[]}],d={rightToc:p};function b(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(s.b)("wrapper",Object(o.a)({},d,n,{components:t,mdxType:"MDXLayout"}),Object(s.b)("p",null,Object(s.b)("a",Object(o.a)({parentName:"p"},{href:"https://docs.google.com/presentation/d/1iimIRpAw1ud1yhCCx1cdwypZw2J8VVN8mTLWXOc8g-U/edit?usp=sharing"}),"Lecture Slides")),Object(s.b)("p",null,Object(s.b)("a",Object(o.a)({parentName:"p"},{href:"https://drive.google.com/file/d/14JeWpqIm4uiTl0bSO8hgvg_kqVadsR0Z/view?usp=sharing"}),"Lecture Video")),Object(s.b)("p",null,Object(s.b)("a",Object(o.a)({parentName:"p"},{href:"https://firebase.google.com/docs/firestore"}),"Firebase Documentation")),Object(s.b)("p",null,Object(s.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/ashneeldas2/trends-sp20/tree/master/Assignments/a2"}),"Assignment 2")," due ",Object(s.b)("strong",{parentName:"p"},"03/04 7:59pm")),Object(s.b)("h2",{id:"before-the-lecture"},"Before the lecture"),Object(s.b)("h3",{id:"install-postman"},"Install Postman"),Object(s.b)("p",null,"Install Postman from ",Object(s.b)("a",Object(o.a)({parentName:"p"},{href:"https://www.postman.com/downloads/"}),"https://www.postman.com/downloads/"),"\nIf necessary, set up a Postman account using your Cornell email address."),Object(s.b)("h3",{id:"firebase-setup"},"Firebase Setup"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"Create an account on ",Object(s.b)("a",Object(o.a)({parentName:"li"},{href:"https://firebase.google.com"}),"Firebase"),". You only need the free version."),Object(s.b)("li",{parentName:"ol"},"Go to Firebase console and click ",Object(s.b)("inlineCode",{parentName:"li"},"Add project"),". Choose any random name for the project name. You\nwon't need Google Analytics in this class but it is fine to enable it. Analytics location doesn't\nmatter, leave it at default United States and check the remaining boxes agreeing to terms and click ",Object(s.b)("inlineCode",{parentName:"li"},"Create project"),"."),Object(s.b)("li",{parentName:"ol"},"Once your project is created, go into it and go to the ",Object(s.b)("inlineCode",{parentName:"li"},"Database")," tab under ",Object(s.b)("inlineCode",{parentName:"li"},"Develop"),". Choose to create database starting in production mode. Keep the Firestore location as default."),Object(s.b)("li",{parentName:"ol"},"Download the service account in ",Object(s.b)("inlineCode",{parentName:"li"},"Project Settings > Service accounts")," as ",Object(s.b)("inlineCode",{parentName:"li"},"service-account.json"),". ",Object(s.b)("inlineCode",{parentName:"li"},"Project Settings")," can be found by clicking the gear button on the left panel next to ",Object(s.b)("inlineCode",{parentName:"li"},"Project Overview"),". Go to ",Object(s.b)("inlineCode",{parentName:"li"},"Service accounts")," tab and click the ",Object(s.b)("inlineCode",{parentName:"li"},"Generate new private key button"),". Save the downloaded file as ",Object(s.b)("inlineCode",{parentName:"li"},"service-account.json"),"\nThis json should be kept secret.")),Object(s.b)("h3",{id:"check-your-setup"},"Check your setup"),Object(s.b)("h4",{id:"code"},"Code"),Object(s.b)("p",null,"Create a folder with empty ",Object(s.b)("inlineCode",{parentName:"p"},"package.json")," and empty ",Object(s.b)("inlineCode",{parentName:"p"},"index.js"),". Put the downloaded\n",Object(s.b)("inlineCode",{parentName:"p"},"service-account.json")," in this folder."),Object(s.b)("p",null,"Copy the following code into ",Object(s.b)("inlineCode",{parentName:"p"},"package.json"),"."),Object(s.b)("pre",null,Object(s.b)("code",Object(o.a)({parentName:"pre"},{className:"language-json"}),'{\n  "name": "self-check",\n  "version": "0.1.0",\n  "main": "index.js",\n  "license": "MIT",\n  "dependencies": {\n    "body-parser": "^1.18.3",\n    "express": "^4.16.4",\n    "firebase-admin": "^7.2.0"\n  }\n}\n')),Object(s.b)("p",null,"Copy the following code into ",Object(s.b)("inlineCode",{parentName:"p"},"index.js"),". Remember to replace ",Object(s.b)("inlineCode",{parentName:"p"},"databaseURL")," with\nthe url of your own. You can find this ",Object(s.b)("inlineCode",{parentName:"p"},"databaseURL")," in the code snippet in the service accounts tab of Firebase."),Object(s.b)("p",null,Object(s.b)("em",{parentName:"p"},"Don't worry if you don't understand this code! You'll know what it does and how to write similar code by the end of this course!")),Object(s.b)("pre",null,Object(s.b)("code",Object(o.a)({parentName:"pre"},{className:"language-javascript"}),"const admin = require('firebase-admin');\nconst serviceAccount = require('./service-account.json');\nconst express = require('express');\nconst bodyParser = require('body-parser');\n\nadmin.initializeApp({\n  credential: admin.credential.cert(serviceAccount),\n  databaseURL: '[YOUR_OWN_DATABASE_URL]',\n});\n\nconst db = admin.firestore();\n\nconst app = express();\nconst port = 8080;\napp.use(bodyParser.json());\n\napp.get('/', (_, resp) => resp.send('Hello World!'));\n\napp.get('/self-check', async (_, resp) => {\n  const data = {\n    name: 'Hello World',\n    time: admin.firestore.FieldValue.serverTimestamp(),\n  };\n  console.log('Sending doc to DB.');\n  await db.collection('test').doc('random-id').set(data);\n  console.log('Doc recorded in DB');\n  const docRef = db.collection('test').doc('random-id');\n  console.log('Trying to obtain doc in DB.');\n  const docSnapshot = await docRef.get();\n  console.log(\n    `We obtained a doc with id ${docSnapshot.id}. It's content is logged below:`\n  );\n  console.log(docSnapshot.data());\n  console.log('Now we will try to remove it.');\n  await docRef.delete();\n  console.log('The document is deleted.');\n  console.log(\n    'After all these operations, the db should be empty. We check that.'\n  );\n  db.collection('test')\n    .get()\n    .then((querySnapshot) => {\n      if (querySnapshot.docs.length === 0) {\n        console.log('We passed the check. The page in browser should say OK.');\n        resp.status(200).send('OK.');\n      } else {\n        console.log('We failed the check. Please check your setup.');\n        resp.status(500).send('Something is messed up!');\n      }\n    });\n});\n\napp.listen(port, () => console.log(`Example app listening on port ${port}!`));\n")),Object(s.b)("h4",{id:"verify-that-it-works"},"Verify that it works"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"Run ",Object(s.b)("inlineCode",{parentName:"li"},"yarn install"),";"),Object(s.b)("li",{parentName:"ol"},"Run ",Object(s.b)("inlineCode",{parentName:"li"},"node index.js"),";"),Object(s.b)("li",{parentName:"ol"},"Open ",Object(s.b)("a",Object(o.a)({parentName:"li"},{href:"http://localhost:8080"}),Object(s.b)("inlineCode",{parentName:"a"},"http://localhost:8080")),". You will see\n",Object(s.b)("inlineCode",{parentName:"li"},"Hello World!"),";"),Object(s.b)("li",{parentName:"ol"},"Open ",Object(s.b)("a",Object(o.a)({parentName:"li"},{href:"http://localhost:8080/self-check"}),Object(s.b)("inlineCode",{parentName:"a"},"http://localhost:8080/self-check")),".\nYou will see ",Object(s.b)("inlineCode",{parentName:"li"},"OK!")," in the browser. In the terminal, you will see something\nlike this:")),Object(s.b)("pre",null,Object(s.b)("code",Object(o.a)({parentName:"pre"},{className:"language-text"}),"Example app listening on port 8080!\nSending doc to DB.\nDoc recorded in DB\nTrying to obtain doc in DB.\nWe obtained a doc with id random-id. It's content is logged below:\n{ name: 'Hello World',\n  time: Timestamp { _seconds: 1554738493, _nanoseconds: 994000000 } }\nNow we will try to remove it.\nThe document is deleted.\nAfter all these operations, the db should be empty. We check that.\nWe passed the check. The page in browser should say OK.\n")),Object(s.b)("h2",{id:"basic-database-manipulations"},"Basic Database Manipulations"),Object(s.b)("p",null,"People usually call that ",Object(s.b)("inlineCode",{parentName:"p"},"CRUD"),", which stands for:"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},Object(s.b)("strong",{parentName:"li"},"C"),"reate/Insert - Create a document (will fail if the document exists)"),Object(s.b)("li",{parentName:"ul"},Object(s.b)("strong",{parentName:"li"},"R"),"ead/Find/Query - To search for documents based on their properties"),Object(s.b)("li",{parentName:"ul"},Object(s.b)("strong",{parentName:"li"},"U"),"pdate - Update an existing document (will fail otherwise)"),Object(s.b)("li",{parentName:"ul"},Object(s.b)("strong",{parentName:"li"},"D"),"elete - Delete an existing document")),Object(s.b)("p",null,"For convenience, most NoSQL database also provides an ",Object(s.b)("em",{parentName:"p"},"upsert")," operation. It\nwill create the document or update an existing document. You can think of that\nas an atomic operation that does:"),Object(s.b)("pre",null,Object(s.b)("code",Object(o.a)({parentName:"pre"},{className:"language-javascript"}),"if (document.exists()) {\n  database.update(document);\n} else {\n  database.insert(document);\n}\n")),Object(s.b)("p",null,"In Firestore, you can either insert a new document with a specified ID, or allow\nFirestore to generate its own ID for you."),Object(s.b)("p",null,"The update method in Firestore allows you to update certain fields of the\ndocument without overwriting the entire thing."),Object(s.b)("h2",{id:"sample-code"},"Sample code"),Object(s.b)("p",null,"The following code demonstrate how we can do basic CRUD with Firestore.\nNote that the code below does not care about what are the fields of a post,\nbecause Firestore doesn't require you to have a predefined set of field. This\ngives you flexibility when writing your backend code."),Object(s.b)(r.a,{groupId:"lang",defaultValue:"ts",values:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}],mdxType:"Tabs"},Object(s.b)(i.a,{value:"ts",mdxType:"TabItem"},Object(s.b)("pre",null,Object(s.b)("code",Object(o.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="index.ts"',title:'"index.ts"'}),"// in typescript import packages as modules\nimport admin from 'firebase-admin';\nimport express from 'express'; // also install type aliases for Request, Response\nimport bodyParser from 'body-parser';\n\nconst serviceAccount = require('./service-account.json');\n\nadmin.initializeApp({\n  credential: admin.credential.cert(serviceAccount),\n  databaseURL: 'https://dti-web-dev-sp19-db-demo.firebaseio.com',\n});\n\nconst db = admin.firestore();\n\nconst app = express();\nconst port: number = 8080;\napp.use(bodyParser.json());\n\n// Define a type for our Post document stored in Firebase\ntype Post = {\n  content: string;\n  name: string;\n};\n\ntype PostWithID = Post & {\n  id: string;\n};\n\napp.get('/', (_, res) => res.send('Hello World!'));\n\nconst postsCollection = db.collection('posts');\n\n// create a post\napp.post('/post', function (req, res) {\n  const post: Post = req.body;\n  const myDoc = postsCollection.doc();\n  myDoc.set(post);\n  res.send(myDoc.id);\n});\n\n// read all posts\napp.get('/post', async function (_, res) {\n  // we don't use the first request parameter\n  const allPostsDoc = await postsCollection.get();\n  const posts: PostWithID[] = [];\n  for (let doc of allPostsDoc.docs) {\n    let post: PostWithID = doc.data() as PostWithID;\n    post.id = doc.id;\n    posts.push(post);\n  }\n  res.send(posts);\n});\n\n// read posts by name\napp.get('/post/:name', async function (req, res) {\n  const namePostsDoc = await postsCollection\n    .where('name', '==', req.params.name)\n    .get();\n  const posts: PostWithID[] = [];\n  for (let doc of namePostsDoc.docs) {\n    let post: PostWithID = doc.data() as PostWithID;\n    post.id = doc.id;\n    posts.push(post);\n  }\n  res.send(posts);\n});\n\n// sorted posts by name\napp.get('/postsorted', async function (_, res) {\n  // we don't use the first request parameter\n  const sortedPosts = await postsCollection.orderBy('name', 'desc').get();\n  const posts: PostWithID[] = [];\n  for (let doc of sortedPosts.docs) {\n    let post: PostWithID = doc.data() as PostWithID;\n    post.id = doc.id;\n    posts.push(post);\n  }\n  res.send(posts);\n});\n\n// update a post\napp.post('/post/:id', async function (req, res) {\n  const id: string = req.params.id;\n  const newPost = req.body;\n  await postsCollection.doc(id).update(newPost);\n  res.send('UPDATED');\n});\n\n// delete a post\napp.delete('/post/:id', async function (req, res) {\n  const id: string = req.params.id;\n  await postsCollection.doc(id).delete();\n  res.send('DELETED');\n});\n\napp.listen(port, () => console.log(`Example app listening on port ${port}!`));\n")),Object(s.b)("p",null,"For TypeScript, we need to compile this down to JavaScript before we run it:"),Object(s.b)("pre",null,Object(s.b)("code",Object(o.a)({parentName:"pre"},{className:"language-bash"}),"tsc index.ts\nnode index.js\n")),Object(s.b)("p",null,"The first command compiles ",Object(s.b)("inlineCode",{parentName:"p"},"index.ts")," to a JS file of the same name. The second runs that JS file.")),Object(s.b)(i.a,{value:"js",mdxType:"TabItem"},Object(s.b)("pre",null,Object(s.b)("code",Object(o.a)({parentName:"pre"},{className:"language-javascript",metastring:'title="index.js"',title:'"index.js"'}),"const admin = require('firebase-admin');\nconst serviceAccount = require('./service-account.json');\nconst express = require('express');\nconst bodyParser = require('body-parser');\n\nadmin.initializeApp({\n  credential: admin.credential.cert(serviceAccount),\n  databaseURL: 'https://dti-web-dev-sp19-db-demo.firebaseio.com',\n});\n\nconst db = admin.firestore();\n\nconst app = express();\nconst port = 8080;\napp.use(bodyParser.json());\n\napp.get('/', (req, res) => res.send('Hello World!'));\n\nconst postsCollection = db.collection('posts');\n\n// create a post\napp.post('/post', function (req, res) {\n  const post = req.body;\n  const myDoc = postsCollection.doc();\n  myDoc.set(post);\n  res.send(myDoc.id);\n});\n\n// read all posts\napp.get('/post', async function (req, res) {\n  const allPostsDoc = await postsCollection.get();\n  const posts = [];\n  for (let doc of allPostsDoc.docs) {\n    let post = doc.data();\n    post.id = doc.id;\n    posts.push(post);\n  }\n  res.send(posts);\n});\n\n// read posts by name\napp.get('/post/:name', async function (req, res) {\n  const namePostsDoc = await postsCollection\n    .where('name', '==', req.params.name)\n    .get();\n  const posts = [];\n  for (let doc of namePostsDoc.docs) {\n    let post = doc.data();\n    post.id = doc.id;\n    posts.push(post);\n  }\n  res.send(posts);\n});\n\n// sorted posts by name\napp.get('/postsorted', async function (req, res) {\n  const sortedPosts = await postsCollection.orderBy('name', 'desc').get();\n  const posts = [];\n  for (let doc of sortedPosts.docs) {\n    let post = doc.data();\n    post.id = doc.id;\n    posts.push(post);\n  }\n  res.send(posts);\n});\n\n// update a post\napp.post('/post/:id', async function (req, res) {\n  const id = req.params.id;\n  const newPost = req.body;\n  await postsCollection.doc(id).update(newPost);\n  res.send('UPDATED');\n});\n\n// delete a post\napp.delete('/post/:id', async function (req, res) {\n  const id = req.params.id;\n  await postsCollection.doc(id).delete();\n  res.send('DELETED');\n});\n\napp.listen(port, () => console.log(`Example app listening on port ${port}!`));\n")),Object(s.b)("p",null,"Run it using ",Object(s.b)("inlineCode",{parentName:"p"},"node index.js"),"!"))))}b.isMDXComponent=!0},162:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return m}));var o=n(0),a=n.n(o);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},s=Object.keys(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),p=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i({},t,{},e)),n},d=function(e){var t=p(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},u=Object(o.forwardRef)((function(e,t){var n=e.components,o=e.mdxType,s=e.originalType,r=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=p(n),u=o,m=d["".concat(r,".").concat(u)]||d[u]||b[u]||s;return n?a.a.createElement(m,i({ref:t},l,{components:n})):a.a.createElement(m,i({ref:t},l))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var s=n.length,r=new Array(s);r[0]=u;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,r[1]=i;for(var l=2;l<s;l++)r[l]=n[l];return a.a.createElement.apply(null,r)}return a.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},163:function(e,t,n){var o;!function(){"use strict";var n={}.hasOwnProperty;function a(){for(var e=[],t=0;t<arguments.length;t++){var o=arguments[t];if(o){var s=typeof o;if("string"===s||"number"===s)e.push(o);else if(Array.isArray(o)&&o.length){var r=a.apply(null,o);r&&e.push(r)}else if("object"===s)for(var i in o)n.call(o,i)&&o[i]&&e.push(i)}}return e.join(" ")}e.exports?(a.default=a,e.exports=a):void 0===(o=function(){return a}.apply(t,[]))||(e.exports=o)}()},165:function(e,t,n){"use strict";var o=n(0),a=Object(o.createContext)({tabGroupChoices:{},setTabGroupChoices:function(){}});t.a=a},166:function(e,t,n){"use strict";var o=n(0),a=n.n(o);t.a=function(e){return a.a.createElement("div",null,e.children)}},167:function(e,t,n){"use strict";n(24),n(19),n(20);var o=n(0),a=n.n(o),s=n(165);var r=function(){return Object(o.useContext)(s.a)},i=n(163),c=n.n(i),l=n(131),p=n.n(l),d=37,b=39;t.a=function(e){var t=e.block,n=e.children,s=e.defaultValue,i=e.values,l=e.groupId,u=r(),m=u.tabGroupChoices,h=u.setTabGroupChoices,f=Object(o.useState)(s),j=f[0],O=f[1];if(null!=l){var g=m[l];null!=g&&g!==j&&O(g)}var y=function(e){O(e),null!=l&&h(l,e)},w=[];return a.a.createElement("div",null,a.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:c()("tabs",{"tabs--block":t})},i.map((function(e){var t=e.value,n=e.label;return(a.a.createElement("li",{role:"tab",tabIndex:"0","aria-selected":j===t,className:c()("tab-item",p.a.tabItem,{"tab-item--active":j===t}),key:t,ref:function(e){return w.push(e)},onKeyDown:function(e){return function(e,t,n){switch(n.keyCode){case b:!function(e,t){var n=e.indexOf(t)+1;e[n]?e[n].focus():e[0].focus()}(e,t);break;case d:!function(e,t){var n=e.indexOf(t)-1;e[n]?e[n].focus():e[e.length-1].focus()}(e,t)}}(w,e.target,e)},onFocus:function(){return y(t)},onClick:function(){return y(t)}},n))}))),a.a.createElement("div",{role:"tabpanel",className:"margin-vert--md"},o.Children.toArray(n).filter((function(e){return e.props.value===j}))[0]))}}}]);