"use strict";(self.webpackChunktrends_in_web_dev_website=self.webpackChunktrends_in_web_dev_website||[]).push([[1406],{7300:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return h}});var a=t(6687);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=a.createContext({}),d=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=d(e.components);return a.createElement(l.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(t),h=o,k=u["".concat(l,".").concat(h)]||u[h]||c[h]||i;return t?a.createElement(k,r(r({ref:n},p),{},{components:t})):a.createElement(k,r({ref:n},p))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var d=2;d<i;d++)r[d]=t[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},2244:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return d},toc:function(){return p},default:function(){return u}});var a=t(3206),o=t(5421),i=(t(6687),t(7300)),r=["components"],s={id:"lecture9",title:"Lecture 9"},l=void 0,d={unversionedId:"lecture9",id:"version-2020fa/lecture9",isDocsHomePage:!1,title:"Lecture 9",description:"Lecture Video",source:"@site/versioned_docs/version-2020fa/lecture9.md",sourceDirName:".",slug:"/lecture9",permalink:"/docs/2020fa/lecture9",tags:[],version:"2020fa",frontMatter:{id:"lecture9",title:"Lecture 9"},sidebar:"version-2020fa/docs",previous:{title:"Lecture 8",permalink:"/docs/2020fa/lecture8"},next:{title:"Lecture 10",permalink:"/docs/2020fa/lecture10"}},p=[{value:"Yarn Workspaces",id:"yarn-workspaces",children:[{value:"Replacing our familiar workflow",id:"replacing-our-familiar-workflow",children:[],level:3},{value:"Hositing package manager out to root",id:"hositing-package-manager-out-to-root",children:[],level:3},{value:"Local workspace as dependency",id:"local-workspace-as-dependency",children:[],level:3},{value:"Why use workspaces?",id:"why-use-workspaces",children:[],level:3},{value:"Yarn workspaces setup",id:"yarn-workspaces-setup",children:[{value:"Root",id:"root",children:[],level:4},{value:"Backend",id:"backend",children:[],level:4},{value:"Frontend",id:"frontend",children:[],level:4},{value:"Profit!",id:"profit",children:[],level:4}],level:3},{value:"Learn more!",id:"learn-more",children:[],level:3}],level:2},{value:"Authentication",id:"authentication",children:[],level:2},{value:"Security",id:"security",children:[{value:"1. Passwords",id:"1-passwords",children:[],level:3},{value:"2. Input Sanitization",id:"2-input-sanitization",children:[],level:3},{value:"3. Don&#39;t Rely on Client Side Verification",id:"3-dont-rely-on-client-side-verification",children:[],level:3},{value:"4. Separation of Privileges",id:"4-separation-of-privileges",children:[],level:3},{value:"Let&#39;s hack our app!",id:"lets-hack-our-app",children:[{value:"Backend",id:"backend-1",children:[],level:4},{value:"Frontend",id:"frontend-1",children:[],level:4},{value:"Security Best Practices",id:"security-best-practices",children:[],level:4}],level:3}],level:2},{value:"Deployment",id:"deployment",children:[{value:"Deployment Setup",id:"deployment-setup",children:[{value:"Backend",id:"backend-2",children:[{value:"<code>index.ts</code>",id:"indexts",children:[],level:5},{value:"<code>backend/package.json</code>",id:"backendpackagejson",children:[],level:5}],level:4},{value:"Frontend",id:"frontend-2",children:[],level:4},{value:"Root",id:"root-1",children:[{value:"<code>package.json</code>",id:"packagejson",children:[],level:5},{value:"<code>Procfile</code>",id:"procfile",children:[],level:5}],level:4},{value:"Deploy time",id:"deploy-time",children:[],level:4}],level:3}],level:2}],c={toc:p};function u(e){var n=e.components,s=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},c,s,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://drive.google.com/file/d/1W2pFu7ehAC_GqSjfhDUtSZ0Y7VINe1MS/view?usp=sharing"},"Lecture Video")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://docs.google.com/presentation/d/1ee6oDLDs_n2aGa16Gz97comB8Trkv7oQcvxzTiyWqqE/edit#slide=id.g825bd93030_0_0"},"Lecture Slides")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://webdev.cornelldti.org/docs/finalproject#milestone-2"},"Final Project - Milestone 2 due 12/8")),(0,i.kt)("p",null,"Vote for the Lecture 10 topic ",(0,i.kt)("a",{parentName:"p",href:"https://bit.ly/lec10fa20vote"},"here")," by ",(0,i.kt)("strong",{parentName:"p"},"Friday 11:59PM ET")),(0,i.kt)("h2",{id:"yarn-workspaces"},"Yarn Workspaces"),(0,i.kt)("h3",{id:"replacing-our-familiar-workflow"},"Replacing our familiar workflow"),(0,i.kt)("p",null,"Normally, to run both the backend and frontend, we have to do something like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd backend\nyarn install\nyarn start  # start the backend\n\ncd ../frontend\nyarn install\nyarn start  # start the frontend\n")),(0,i.kt)("p",null,"We can make managing the frontend and backend easier by creating a package.json in our root directory and declaring a workspaces!"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="package.json"',title:'"package.json"'},'{\n  "private": true,\n  "workspaces": ["frontend", "backend"]\n}\n')),(0,i.kt)("h3",{id:"hositing-package-manager-out-to-root"},"Hositing package manager out to root"),(0,i.kt)("p",null,"One advantage of doing this is that dependencies are installed at the root, so if both your frontend and backend use the same version of TypeScript, it is only installed once at the workspace root."),(0,i.kt)("p",null,"Another thing you may notice is that only one lockfile is generated and it is placed at the workspace root with ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,i.kt)("p",null,"Having your package manager at your root also makes running scripts from both workspaces much simpler. To run the respective ",(0,i.kt)("inlineCode",{parentName:"p"},"start")," script for the frontend or backend, you can\nrun ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn workspace frontend start")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn workspace backend start")),(0,i.kt)("h3",{id:"local-workspace-as-dependency"},"Local workspace as dependency"),(0,i.kt)("p",null,"If there is code that you wish to be shared between both your frontend and backend, for example, you can also declare that as another workspace in your ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json"),"\nand include it in the respective frontend and backend ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="frontend/package.json"',title:'"frontend/package.json"'},'{\n  "name": "frontend",\n  "version": "1.0.0",\n  "dependencies": {\n    "typescript": "^4.1.2",\n    "react": "^17.0.0",\n    "helper-functions": "1.0.0"\n  }\n}\n')),(0,i.kt)("h3",{id:"why-use-workspaces"},"Why use workspaces?"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Yarn workspaces allows your dependencies to be linked together, making it easier to manage a monorepo"),(0,i.kt)("li",{parentName:"ul"},"Having one lockfile creates fewer conflicts and easier code reviews"),(0,i.kt)("li",{parentName:"ul"},"Reduces redundancy in packages"),(0,i.kt)("li",{parentName:"ul"},"Including workspaces as dependencies makes it easier to test your utility functions locally before you publish them online")),(0,i.kt)("h3",{id:"yarn-workspaces-setup"},"Yarn workspaces setup"),(0,i.kt)("p",null,"We will be showing Yarn workspaces setup on our example Songs App we've been working on throughout the semester. After lecture 8, we bridged the frontend and the backend together to fetch data from our API endpoints defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"backend/index.ts")," to show in the frontend UI."),(0,i.kt)("p",null,"We kept these two folders separate and we showed the old way of ",(0,i.kt)("inlineCode",{parentName:"p"},"cd")," into each folder and running Yarn install. Now with workspaces we can manage the package from the root and directly run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn install")," once to install all frontend and backend dependencies!"),(0,i.kt)("h4",{id:"root"},"Root"),(0,i.kt)("p",null,"To do this, our root ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," will define the workspaces. (Note: root means outside of both the frontend and backend folders, on that same level of the directory hierarchy.)"),(0,i.kt)("p",null,"Most important lines here are 3-7 which define the workspaces and set ",(0,i.kt)("inlineCode",{parentName:"p"},"private: true")," since ",(0,i.kt)("a",{parentName:"p",href:"https://classic.yarnpkg.com/en/docs/workspaces/#toc-how-to-use-it"},"workspaces can't be published"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="/package.json"',title:'"/package.json"'},'{\n  "name": "songs-app",\n  "private": true,\n  "workspaces": ["backend", "frontend"],\n  "version": "1.0.0",\n  "main": "index.js",\n  "license": "MIT"\n}\n')),(0,i.kt)("h4",{id:"backend"},"Backend"),(0,i.kt)("p",null,"Now our backend workspace will look like the following. I've omitted some of the dependencies part for brevity you can find the full file ",(0,i.kt)("a",{parentName:"p",href:"./lecture9#backendpackagejson"},"below")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="backend/package.json"',title:'"backend/package.json"'},'{\n  "name": "backend",\n  "version": "1.0.0",\n  "main": "index.js",\n  "scripts": {\n    "build": "tsc -p tsconfig.json",\n    "start": "node index.js"\n  },\n  "dependencies": {\n    "cors": "^2.8.5",\n    "express": "^4.17.1",\n    "firebase-admin": "^9.4.1"\n  }\n  // dev dependencies...\n}\n')),(0,i.kt)("h4",{id:"frontend"},"Frontend"),(0,i.kt)("p",null,"Our frontend workspace will also look like the following. The full file can also be found is very similar to the default ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," from create react app we have been using all along."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="frontend/package.json"',title:'"frontend/package.json"'},'{\n  "name": "frontend",\n  "version": "0.1.0",\n  "private": true,\n  "proxy": "http://localhost:8080",\n  "dependencies": {\n    "axios": "^0.19.2",\n    "firebase": "^8.1.1",\n    "firebase-tools": "^8.16.2",\n    "react": "^17.0.1"\n  },\n  // other dependencies, dev dependencies\n  "scripts": {\n    "start": "react-scripts start",\n    "build": "react-scripts build",\n    "test": "react-scripts test",\n    "eject": "react-scripts eject"\n  }\n}\n')),(0,i.kt)("h4",{id:"profit"},"Profit!"),(0,i.kt)("p",null,"Now we can profit from all our hardwork setting up by managing everything from the project root. In the root we can run:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"yarn workspace frontend build")," to build our frontend application. This is equivalent to running ",(0,i.kt)("inlineCode",{parentName:"p"},"react-scripts start")," based on ",(0,i.kt)("inlineCode",{parentName:"p"},"frontend/package.json"),"."),(0,i.kt)("p",null,"We can also run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn workspace backend build")," to build our backend application. This is equivalent to running ",(0,i.kt)("inlineCode",{parentName:"p"},"tsc -p tsconfig.json")," based on ",(0,i.kt)("inlineCode",{parentName:"p"},"backend/package.json"),"."),(0,i.kt)("p",null,"In general the syntax for running a script for a workspace is ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn workspace <workspace_name> <script_name>"),". Where ",(0,i.kt)("inlineCode",{parentName:"p"},"<workspace_name>/package.json")," has a value for ",(0,i.kt)("inlineCode",{parentName:"p"},"<script_name>")," in the ",(0,i.kt)("inlineCode",{parentName:"p"},"scripts")," section."),(0,i.kt)("p",null,"We notice we have two build scripts in backend and frontend. ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn workspace run build")," will tell yarn to run build script in all workspaces that have them."),(0,i.kt)("p",null,"Of course, we can also run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn install")," in the project root to install all the dependencies required in all of our workspaces. If there are duplicates, yarn will only install the dependency once."),(0,i.kt)("h3",{id:"learn-more"},"Learn more!"),(0,i.kt)("p",null,"Yarn workspaces is super cool and we just covered a subset of functionality. If you want to learn more check out these links:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://classic.yarnpkg.com/en/docs/workspaces/#toc-how-to-use-it"},"How to use Yarn workspaces")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://classic.yarnpkg.com/blog/2017/08/02/introducing-workspaces/"},"Blog post"))),(0,i.kt)("h2",{id:"authentication"},"Authentication"),(0,i.kt)("p",null,"One of the best parts about Firebase is you can use Sign in with Google/Facebook/GitHub/etc! This way you don't have to deal with usernames and passwords yourself!"),(0,i.kt)("p",null,"Before writing any code, you need to setup Firebase Authentication first."),(0,i.kt)("p",null,"In your project's firebase console, click on the authentication icon below the settings icon:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"authentication icon",src:t(8599).Z})),(0,i.kt)("p",null,"Then click on the sign-in method tab and enable Google login by following the setup instructions:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"sign in method",src:t(807).Z})),(0,i.kt)("p",null,"We did a Live Coding Demo here based on the Songs example from last week. I will include the files changed here."),(0,i.kt)("p",null,"To handle authentication we made a wrapper component ",(0,i.kt)("inlineCode",{parentName:"p"},"Authenticated")," to handle all Authentication:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="Authenticated.tsx"',title:'"Authenticated.tsx"'},"import React, { useState, useEffect } from 'react';\nimport 'firebase/auth';\nimport firebase from 'firebase/app';\nimport FirebaseAuth from 'react-firebaseui/FirebaseAuth';\n\nconst firebaseConfig = {\n  // put firebase config in here.\n  // You can find the config in Project Settings > General\n  // and choose the Config option in Firebase SDK snippet\n};\n\nfirebase.initializeApp(firebaseConfig);\n\ntype Props = {\n  readonly children: React.ReactNode;\n};\n\nconst Authenticated = ({ children }: Props) => {\n  const [user, setUser] = useState<firebase.User | null>(null);\n\n  const uiConfig = {\n    signInFlow: 'popup',\n    signInOptions: [firebase.auth.GoogleAuthProvider.PROVIDER_ID],\n  };\n\n  function onAuthStateChange() {\n    return firebase.auth().onAuthStateChanged((user) => {\n      setUser(user);\n    });\n  }\n\n  useEffect(() => onAuthStateChange(), []);\n\n  return (\n    <div>\n      {user && children}\n      {!user && (\n        <FirebaseAuth uiConfig={uiConfig} firebaseAuth={firebase.auth()} />\n      )}\n    </div>\n  );\n};\n\nexport default Authenticated;\n")),(0,i.kt)("p",null,"We then wrap our whole ",(0,i.kt)("inlineCode",{parentName:"p"},"SongList")," app in ",(0,i.kt)("inlineCode",{parentName:"p"},"Authenticated"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="App.tsx"',title:'"App.tsx"'},"import React from 'react';\nimport './App.css';\nimport SongList from './SongList';\nimport Authenticated from './Authenticated';\n\nconst App = (): React.ReactElement => (\n  <div className=\"App\">\n    <Authenticated>\n      <SongList />\n    </Authenticated>\n  </div>\n);\n\nexport default App;\n")),(0,i.kt)("p",null,"If the user is logged in, ",(0,i.kt)("inlineCode",{parentName:"p"},"SongList")," will show. Otherwise they will be asked to log in."),(0,i.kt)("p",null,"We then deployed this app on Firebase for the frontend and Heroku for the backend. Refer to the commands above."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"We recommend using Firebase's built-in support for Google Authentication since storing passwords securely is ",(0,i.kt)("em",{parentName:"p"},"very hard")," (more details in the security section). Firebase also has support for many other accounts such as Facebook, GitHub, Microsoft, Apple, etc. Read more about Firebase Authentication ",(0,i.kt)("a",{parentName:"p",href:"https://firebase.google.com/docs/auth/web/firebaseui"},"here"),". If for whatever reason you really want to implement your own user accounts, Firebase can still help you store passwords securely. Read more ",(0,i.kt)("a",{parentName:"p",href:"https://firebase.google.com/docs/auth/web/password-auth"},"here"),"."))),(0,i.kt)("h2",{id:"security"},"Security"),(0,i.kt)("p",null,"Web app security is integral in a world where people have malicious intentions. As such, we advocate for at least these basic security measures."),(0,i.kt)("h3",{id:"1-passwords"},"1. Passwords"),(0,i.kt)("p",null,"Do NOT store passwords in plain text in your database!!"),(0,i.kt)("p",null,"If somehow there were a vulnerability in your database, the passwords of all of your users would be directly exposed to hackers.\nMoreover, many people reuse their passwords for some if not all other, so you could also compromise something like someone's banking credentials or emails."),(0,i.kt)("p",null,"While it is safer to store hashed passwords, it is very easy to do it incorrectly, which is why we teach firebase authentication!"),(0,i.kt)("h3",{id:"2-input-sanitization"},"2. Input Sanitization"),(0,i.kt)("p",null,"Input sanitization 'cleanses' inputs so that they can not be used in unintended ways."),(0,i.kt)("p",null,"For example, it may seem reasonable to add every comment on a blog into a database entry like this:\n",(0,i.kt)("inlineCode",{parentName:"p"},"\u201cINSERT INTO 'comments' (comment) VALUES '\u201d + user_input + \u201c';\u201d"),", but it is actually incredibly unsafe\nif ",(0,i.kt)("inlineCode",{parentName:"p"},"user_input")," were something like ",(0,i.kt)("inlineCode",{parentName:"p"},"'; DROP TABLE comments;"),"."),(0,i.kt)("p",null,"Luckily for us, ",(0,i.kt)("a",{parentName:"p",href:"https://reactjs.org/docs/introducing-jsx.html#jsx-prevents-injection-attacks"},"React DOM escapes values embedded in JSX before rendering them by default, preventing injection attacks"),"."),(0,i.kt)("h3",{id:"3-dont-rely-on-client-side-verification"},"3. Don't Rely on Client Side Verification"),(0,i.kt)("p",null,"In general you cannot assume your endpoint will only be used by your frontend."),(0,i.kt)("p",null,"Recall that we used Postman at the beginning of the semester to test Express endpoints. As such, it is always important to verify your inputs and authenticate your requests!"),(0,i.kt)("h3",{id:"4-separation-of-privileges"},"4. Separation of Privileges"),(0,i.kt)("p",null,"Going hand-in-hand with the last point, when a request is made to your backend, make sure that the source of your request has the sufficient permissions to perform whatever action is being asked!"),(0,i.kt)("p",null,"For example, if the OfficeHours app recieved a request to edit the times to someone's office hours, the backend would check that this person is indeed the TA who owns that OH and not a student."),(0,i.kt)("h3",{id:"lets-hack-our-app"},"Let's hack our app!"),(0,i.kt)("p",null,"In lecture, we showed how to hack our very simple application by sending in bad unauthenticated input data. This caused our frontend to break a little bit. Check the lecture video for details!"),(0,i.kt)("p",null,"We fixed the backend by using Firebase Admin's verifyIdToken function to check whether the user had logged in or not."),(0,i.kt)("h4",{id:"backend-1"},"Backend"),(0,i.kt)("p",null,"On the backend, we had the ",(0,i.kt)("inlineCode",{parentName:"p"},"post")," endpoints check the ",(0,i.kt)("inlineCode",{parentName:"p"},"idtoken")," in the request headers."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="backend/index.ts"',title:'"backend/index.ts"'},"// setup, GET route\napp.post('/createSong', async (req, res) => {\n  admin\n    .auth()\n    .verifyIdToken(req.headers.idtoken as string)\n    .then(async () => {\n      const newSong = req.body;\n      const addedSong = await songsCollection.add(newSong);\n      res.send(addedSong.id);\n    })\n    .catch(() => {\n      console.log('auth error');\n    });\n});\n\napp.post('/updateRating', async (req, res) => {\n  admin\n    .auth()\n    .verifyIdToken(req.headers.idtoken as string)\n    .then(async () => {\n      const id = req.query.id as string;\n      const rating = req.query.rating;\n      await songsCollection.doc(id).update({ rating });\n      res.send('Song rating updated!');\n    })\n    .catch(() => {\n      console.log('auth error');\n    });\n});\n")),(0,i.kt)("p",null,"We call ",(0,i.kt)("inlineCode",{parentName:"p"},"admin.auth().verifyIdToken(req.headers.idtoken as string)")," and only then do we allow the input to be saved. Otherwise, we log the error."),(0,i.kt)("h4",{id:"frontend-1"},"Frontend"),(0,i.kt)("p",null,"Now when we send the request back, we need to send the idtoken with the request header. So in the ",(0,i.kt)("inlineCode",{parentName:"p"},"addSong")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"updateRating")," methods that called the POST endpoints above, we send call ",(0,i.kt)("inlineCode",{parentName:"p"},"firebase.auth().currentUser?.getIdToken(true)")," to get the user's idtoken. Then we pass it in as a field to ",(0,i.kt)("inlineCode",{parentName:"p"},"headers")," in the fetch. However, if the currentUser is undefined for some reason (what the ",(0,i.kt)("inlineCode",{parentName:"p"},"?")," catches), then we console that the user isn't authenticated. Everything else should be familiar from last lecture."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="frontend/src/SongList.tsx"',title:'"frontend/src/SongList.tsx"'},"const addSong = (name: string, artist: string, rating: number) => {\n  firebase\n    .auth()\n    .currentUser?.getIdToken(true)\n    .then((idtoken) => {\n      fetch('/createSong', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          idtoken,\n        },\n        body: JSON.stringify({ name, artist, rating }),\n      })\n        .then((res) => res.text())\n        .then((id) => setSongs([...songs, { name, artist, rating, id }]));\n    })\n    .catch(() => {\n      console.log('not authenticated');\n    });\n};\n\nconst updateRating = (id: string, rating: number) => {\n  firebase\n    .auth()\n    .currentUser?.getIdToken(true)\n    .then((idtoken) => {\n      fetch(`/updateRating?id=${id}&rating=${rating}`, {\n        method: 'POST',\n        headers: {\n          idtoken,\n        },\n      }).then(() =>\n        setSongs(\n          songs.map((song) =>\n            song.id === id\n              ? { name: song.name, artist: song.artist, rating, id }\n              : song\n          )\n        )\n      );\n    })\n    .catch(() => {\n      console.log('not authenticated');\n    });\n};\n")),(0,i.kt)("h4",{id:"security-best-practices"},"Security Best Practices"),(0,i.kt)("p",null,"There is a lot more we could've done in terms of security here."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"We should send back error messages to the user about why requests are failing instead of just doing ",(0,i.kt)("inlineCode",{parentName:"li"},"console.log()")," since the user won't see that. This would be bad user experience since they don't have feedback about why things aren't working."),(0,i.kt)("li",{parentName:"ol"},"We should also do input validation on the backend to ensure we are getting our expected inputs. What if we aren't passing an object that looks like:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "artist": string\n  "title": string\n  "rating": number [in 1-5]\n}\n')),(0,i.kt)("h2",{id:"deployment"},"Deployment"),(0,i.kt)("p",null,"To deploy your web application means to put it on a Web server so others can access it via the internet. We will deploy both our frontend and backend on Heroku. There are a variety of services you can use for deployment including Firebase, Amazon AWS, Microsoft Azure, etc, but we decided to show you Heroku deployment since it is easier and requires less setup."),(0,i.kt)("p",null,"We will be taking our songs app we have been building throughout the course and deploying it to a remote server. To deploy your own app (for final project for example), you can follow the same steps usually."),(0,i.kt)("h3",{id:"deployment-setup"},"Deployment Setup"),(0,i.kt)("h4",{id:"backend-2"},"Backend"),(0,i.kt)("h5",{id:"indexts"},(0,i.kt)("inlineCode",{parentName:"h5"},"index.ts")),(0,i.kt)("p",null,"To deploy to Heroku we need some additional setup. We will be serving our frontend via our backend so express should grab files from the ",(0,i.kt)("inlineCode",{parentName:"p"},"frontend/build")," folder. In the frontend folder, when you run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn build"),", you will get a ",(0,i.kt)("inlineCode",{parentName:"p"},"build")," directory containing all the optimized, bundled frontend React code ready to be pushed to a remote server. We will include the line ",(0,i.kt)("inlineCode",{parentName:"p"},"app.use(express.static(path.join(__dirname, '../frontend/build')));")," to do this. (Note: this requires us to ",(0,i.kt)("inlineCode",{parentName:"p"},"import path from 'path';"),")"),(0,i.kt)("p",null,"We will also be calling upon our express app to use CORS to allow cross origin requests. If your backend requests are being blocked be of some ",(0,i.kt)("inlineCode",{parentName:"p"},"CORS cross origin policy")," issue you probably forgot to include the ",(0,i.kt)("inlineCode",{parentName:"p"},"app.use(cors());")," line. (Note: this requires us to ",(0,i.kt)("inlineCode",{parentName:"p"},"import cors from 'cors';"),")"),(0,i.kt)("p",null,"The beginning of your ",(0,i.kt)("inlineCode",{parentName:"p"},"backend/index.ts")," should look like the below. Note the CORS line (line 12) and express static serving line (line 13) we described above and the relevant import statements."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="backend/index.ts"',title:'"backend/index.ts"'},"import express from 'express';\nimport admin from 'firebase-admin';\nimport cors from 'cors';\nimport path from 'path';\n\nconst serviceAccount = require('./serviceAccount.json');\n\nadmin.initializeApp({\n  credential: admin.credential.cert(serviceAccount),\n  databaseURL: '', // add dbURL\n});\n\nconst app = express();\napp.use(cors());\napp.use(express.static(path.join(__dirname, '../frontend/build')));\napp.use(express.json());\nconst db = admin.firestore();\n\nconst songsCollection = db.collection('songs');\n\napp.get('/getSongs', async (req, res) => {\n  const songs = await songsCollection.get();\n  res.json(songs.docs.map((song) => ({ ...song.data(), id: song.id })));\n});\n\n// other routes...\napp.listen(process.env.PORT || 8080, () => console.log('backend started'));\n")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Notice we are having ",(0,i.kt)("inlineCode",{parentName:"p"},"app.listen")," listen for either port 8080 or ",(0,i.kt)("inlineCode",{parentName:"p"},"process.env.PORT"),". Previously, we hardcoded ",(0,i.kt)("inlineCode",{parentName:"p"},"8080")," for this parameter. ",(0,i.kt)("inlineCode",{parentName:"p"},"process.env.PORT")," will be defined by Heroku and we want the app to listen for requests on that port in the deployed site."))),(0,i.kt)("h5",{id:"backendpackagejson"},(0,i.kt)("inlineCode",{parentName:"h5"},"backend/package.json")),(0,i.kt)("p",null,"Our ",(0,i.kt)("inlineCode",{parentName:"p"},"backend/package.json")," will look like this since we need to compile the TypeScript to JavaScript first. The build step calls ",(0,i.kt)("inlineCode",{parentName:"p"},"tsc")," the TypeScript compiler to compile the ",(0,i.kt)("inlineCode",{parentName:"p"},"index.ts")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"index.js"),". You should see a new ",(0,i.kt)("inlineCode",{parentName:"p"},"index.js")," file after you run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn build"),"."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"We are using the same ",(0,i.kt)("inlineCode",{parentName:"p"},"tsconfig.json")," as found in ",(0,i.kt)("a",{parentName:"p",href:"./lecture2#tsconfigjson"},"lecture2"),"."))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="backend/package.json"',title:'"backend/package.json"'},'{\n  "name": "backend",\n  "version": "1.0.0",\n  "main": "index.js",\n  "scripts": {\n    "build": "tsc -p tsconfig.json",\n    "start": "node index.js"\n  },\n  "license": "MIT",\n  "dependencies": {\n    "cors": "^2.8.5",\n    "express": "^4.17.1",\n    "firebase-admin": "^9.4.1"\n  },\n  "devDependencies": {\n    "heroku": "^7.47.3",\n    "ts-node": "^9.0.0",\n    "typescript": "^4.1.2",\n    "@types/cors": "^2.8.8",\n    "@types/express": "^4.17.9",\n    "@types/node": "^14.14.10"\n  }\n}\n')),(0,i.kt)("h4",{id:"frontend-2"},"Frontend"),(0,i.kt)("p",null,"No further setup required in our frontend folder."),(0,i.kt)("h4",{id:"root-1"},"Root"),(0,i.kt)("h5",{id:"packagejson"},(0,i.kt)("inlineCode",{parentName:"h5"},"package.json")),(0,i.kt)("p",null,"Our root ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," will look like the following. We are using yarn workspaces as described ",(0,i.kt)("a",{parentName:"p",href:"./lecture9#root"},"above")," and the ",(0,i.kt)("inlineCode",{parentName:"p"},"heroku-postbuild")," script will build both workspaces to prep them for push to remote server. (We discussed ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn workspaces run build")," ",(0,i.kt)("a",{parentName:"p",href:"./lecture9#profit"},"above"),") ",(0,i.kt)("inlineCode",{parentName:"p"},"heroku-postbuild")," is a special command recognized by Heroku to allow you to customize the build process."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="/package.json"',title:'"/package.json"'},'{\n  "name": "songs-app",\n  "private": true,\n  "scripts": {\n    "heroku-postbuild": "yarn workspaces run build"\n  },\n  "workspaces": ["backend", "frontend"],\n  "version": "1.0.0",\n  "main": "index.js",\n  "license": "MIT",\n  "devDependencies": {\n    "heroku": "^7.47.3"\n  }\n}\n')),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The root ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," can have dependencies and yarn will install them with ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn install")," just like everything else. You will just need to run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn add -W <pkg_name>")," since just using ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn add")," will show a warning message asking if you are sure about adding a dependency to the root. We add Heroku in this case to help with deployment!"))),(0,i.kt)("p",null,"Read more about ",(0,i.kt)("inlineCode",{parentName:"p"},"heroku-postbuild")," ",(0,i.kt)("a",{parentName:"p",href:"https://devcenter.heroku.com/articles/nodejs-support#customizing-the-build-process"},"here"),"."),(0,i.kt)("h5",{id:"procfile"},(0,i.kt)("inlineCode",{parentName:"h5"},"Procfile")),(0,i.kt)("p",null,"We will also have Procfile that tells Heroku what script to run to start the application. In this case we will be using the backend ",(0,i.kt)("inlineCode",{parentName:"p"},"node index.js")," to start the backend listening for requests and serving the frontend assets from the ",(0,i.kt)("inlineCode",{parentName:"p"},"frontend/build")," folder."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Procfile"',title:'"Procfile"'},"web: yarn workspace backend start\n")),(0,i.kt)("p",null,"Read more about the Heroku Procfile ",(0,i.kt)("a",{parentName:"p",href:"https://devcenter.heroku.com/articles/procfile"},"here"),"."),(0,i.kt)("h4",{id:"deploy-time"},"Deploy time"),(0,i.kt)("p",null,"We will now show the series of commands to deploy to Heroku. We will be using Heroku Git to deploy."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'yarn add heroku\ngit init\ngit add .\ngit commit -m "COMMIT MESSAGE"\nyarn heroku login\nyarn heroku create <optional project name>\ngit push heroku master\n(optional) yarn heroku open\n')),(0,i.kt)("p",null,"Visiting the URL should take you to the same application you had locally. Now you can share that link with your friends so they can visit your website too! Take a look at our deployed site here: ",(0,i.kt)("a",{parentName:"p",href:"https://webdev-demo-fa20.herokuapp.com/"},"https://webdev-demo-fa20.herokuapp.com/")," (If you have issues deploying feel free to submit this link for the attendance question, but please do come to ",(0,i.kt)("a",{parentName:"p",href:"./introduction#when-are-office-hours"},"office hours")," first!)"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you run into issues that the app isn't authorized to use authentication, go to your Firebase project on ",(0,i.kt)("a",{parentName:"p",href:"https://firebase.google.com/"},"firebase.google.com")," > Go to Console > ","[your project]"," > Authentication ","[on sidebar]"," > Sign-in Method > Authorized domains > Add Domain and enter the URL of your deployed site."))),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"In your final submission of your final project, we want you to follow these steps to deploy your app to Heroku and place the link in the ",(0,i.kt)("inlineCode",{parentName:"p"},"README.md"),". If you prefer to deploy on another platform feel free but we do not guarantee we know how to debug any issues that come up."))))}u.isMDXComponent=!0},8599:function(e,n,t){n.Z=t.p+"assets/images/authentication-icon-6219e823efacb6f2d39630fc21d027bb.png"},807:function(e,n,t){n.Z=t.p+"assets/images/signin-method-a02703a228bc864af687a9d2cd2090c9.png"},3206:function(e,n,t){function a(){return a=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},a.apply(this,arguments)}t.d(n,{Z:function(){return a}})},5421:function(e,n,t){function a(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}t.d(n,{Z:function(){return a}})}}]);